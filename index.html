<!DOCTYPE html>
<html>
<head>
  <title>Where Am I?</title>
  <style type="text/css">
    .shrink {
      width: 0px !important;
      height: 0px !important;
      overflow: hidden;
    }
  </style>
</head>

<script type="text/javascript">
  var host = 'matthewja.com';
  if ((host == window.location.host) &&
      (window.location.protocol != 'https:')) {
    window.location.protocol = 'https';
  }
</script>

<body>

<div id="content">Loading...</div>

<div class="shrink"><!-- <iframe id="tuneframe"
        width="200"
        height="200"
        src="https://www.youtube.com/embed/gWTZbEbv2gs?Version=3&amp;loop=1&amp;autoplay=1&amp;playlist=gWTZbEbv2gs"
        frameborder="0"
        allowfullscreen="0"
        autoplay="1"
        loop="1">
</iframe> --><div id="player"></div></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>

// Globals.

var content = document.getElementById('content');
var tuneFrame = document.getElementById('tuneframe');
var coordinates = [];
var currentIndex = null;
var tunes = [
  'Oa-Wv4CY1JM',
  '9cS3KPQgvVE',
  'CV_2u6EDx6c',
  'JSbuAEOrsp0',
  'Y71w6N8HK_Q',
  'mP35Qu0pQSo',
  'DGs829KmRp8',
  'BtrujKSOiXI',
  'iKtVNx4fFos',
  '7jTjfkzfbwg',
  'CbE87Pv2pqs',
  'p8DB6jGnpfY',
  'eo9j-c_QIeU',
  'JyzCDg6NYNc',
  'Cxoykc-chqg',
  'DQEww_hYON4',

  'LzxKmPYL73g',
  'DJUxTo0tTOs',
  'OqsgB2TZ9Ks',
  'T8cLW0Lckhc',
];
var defaultTune = 'gWTZbEbv2gs';
var maxIndex = tunes.length;
var player;

// Wrap geolocation API with Promises.

function getPosition() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(resolve, reject);
  });
}

// Helpers.

function makeEmbedURL(video) {
  return 'https://www.youtube.com/embed/' + video + '?Version=3&loop=1&autoplay=1&playlist=' + video;
}

function latLon(position) {
  return [position.coords.latitude, position.coords.longitude];
}

function inside(point, vs) {
  // ray-casting algorithm based on
  // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html
  // taken from https://github.com/substack/point-in-polygon
  // The MIT License (MIT)

  // Copyright (c) 2016 James Halliday

  // Permission is hereby granted, free of charge, to any person obtaining a copy
  // of this software and associated documentation files (the "Software"), to deal
  // in the Software without restriction, including without limitation the rights
  // to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  // copies of the Software, and to permit persons to whom the Software is
  // furnished to do so, subject to the following conditions:

  // The above copyright notice and this permission notice shall be included in all
  // copies or substantial portions of the Software.

  // THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  // IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  // FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  // AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  // LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  // OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  // SOFTWARE.
  var x = point[0], y = point[1];

  var inside = false;
  for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
      var xi = vs[i][0], yi = vs[i][1];
      var xj = vs[j][0], yj = vs[j][1];

      var intersect = ((yi > y) != (yj > y))
          && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
  }
  return inside;
}

function hash(string) {
  // http://stackoverflow.com/a/7616484/1105803
  var hash = 0, i, chr, len;
  if (string.length === 0) return hash;
  for (i = 0, len = string.length; i < len; i++) {
    chr = string.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return hash;
}

function getSA1(lat, lon) {
  var found = false;
  for (var i = 0; i < coordinates.length; i++) {
    if (inside([lon, lat], coordinates[i].shape)) {
      return coordinates[i];
    }
  }
}

function setTune(index) {
  // tuneFrame.src = makeEmbedURL(tunes[index]);
  player.loadVideoById(tunes[index]);
}

function update(lat, lon) {
  var sa1 = getSA1(lat, lon);
  var name = sa1.record[4];
  sa1 = sa1.record[0]
  var index = sa1 % maxIndex;
  if (index !== currentIndex) {
    currentIndex = index;
    setTune(index);
  }
  content.innerHTML = 'Found location: ' + name;
}

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '390',
    width: '640',
    videoId: defaultTune,
    events: {
      onReady: (event) => { event.target.playVideo(); },
      // 'onStateChange': onPlayerStateChange
    },
    playerVars: {
      autoplay: 1,
      enablejsapi: 1,
      loop: 1,
      playlist: defaultTune,
      origin: 'matthewja.com',
    },
  });
}

// Main.

var positionOptions = {
  timeout: 1000,
  maximumAge: 60 * 1000,
};

fetch('coordinates_act_southport.json', {cache: 'force-cache'})
  .then((response) => response.json())
  .then((coordinates) => {
    // Load all the area coordinates.
    window.coordinates = coordinates;
    // Set a callback for location.
    navigator.geolocation.watchPosition((position) => {
      update(position.coords.latitude, position.coords.longitude);
    }, null, positionOptions);
  })
  .catch((err) => {
    content.innerHTML = 'Unhandled error: ' + err.message;
  });

</script>
</body>
</html>